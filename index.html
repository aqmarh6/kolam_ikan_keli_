<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">

<!-- FIX UNTUK PHONE -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Monitoring Kolam Ikan Keli</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,sans-serif;
  background:linear-gradient(135deg,#0a3d62,#1e90ff);
  color:white;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px;
  background:#00000040;
}
header img{height:45px}

.top-box{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
  gap:10px;
  padding:15px;
}

.box{
  background:#ffffff25;
  border-radius:15px;
  padding:10px;
  text-align:center;
}
.box h2{margin:5px 0;font-size:16px}
.box p{margin:5px 0;font-size:22px;font-weight:bold}
.box span{font-size:12px}

.refresh-box{text-align:center;margin-bottom:10px;}

button{
  background:#0f6abf;
  border:none;
  padding:10px 20px;
  font-size:15px;
  color:white;
  border-radius:25px;
  cursor:pointer;
}

table{width:100%;border-collapse:collapse;}
th,td{
  padding:6px;
  text-align:center;
  border-bottom:1px solid #ffffff40;
  font-size:13px;
}
th{background:#0f6abf}
</style>
</head>

<body>

<header>
  <img src="kv_chenor.png">
  <b style="font-size:14px;">Monitoring Kolam Ikan Keli</b>
  <img src="umpsa.png">
</header>

<div class="top-box">
  <div class="box">
    <h2>pH</h2>
    <p id="ph">-</p>
    <span id="phTime">-</span>
  </div>
  <div class="box">
    <h2>Turbidity</h2>
    <p id="turbidity">-</p>
    <span id="turTime">-</span>
  </div>
  <div class="box">
    <h2>Suhu Â°C</h2>
    <p id="temp">-</p>
    <span id="tempTime">-</span>
  </div>
</div>

<div class="refresh-box">
  <button onclick="loadData()">ðŸ”„ Refresh</button><br><br>

  ðŸ“… Pilih Tarikh:
  <input 
    type="date" 
    id="dateFilter" 
    onchange="loadData()"
    style="color:black;padding:5px;border-radius:8px;border:none;"
  >
</div>

<div style="display:flex;justify-content:center;gap:10px;margin:10px;">
  <img src="ikan_keli1.png" style="height:90px;border-radius:15px;">
  <img src="ikan_keli2.png" style="height:90px;border-radius:15px;">
</div>

<div>
  <canvas id="chart"></canvas>
</div>

<div>
  <div style="max-height:250px;overflow-y:auto;">
    <table>
      <thead>
        <tr>
          <th>Masa</th>
          <th>pH</th>
          <th>Turbidity</th>
          <th>Suhu</th>
        </tr>
      </thead>
      <tbody id="tableData"></tbody>
    </table>
  </div>
</div>

<script>
google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(loadData);

const SHEET_ID = "1dvpDldtPfPRVXpvipldZZs-PlpF2J4ZF-xa1-gFyqKU";
const SHEET_NAME = "Sheet1";

function loadData() {
  const q = new google.visualization.Query(
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}`
  );

  q.send(res => {
    if (res.isError()) return;

    const d = res.getDataTable();
    const r = d.getNumberOfRows();
    if (r === 0) return;

    let labels = [], ph = [], tu = [], te = [];
    let table = document.getElementById("tableData");
    table.innerHTML = "";

    const selectedDate = document.getElementById("dateFilter").value;

    for (let i = 0; i < r; i++) {
      let masa = d.getValue(i,0).toString();
      if (selectedDate && !masa.includes(selectedDate)) continue;

      labels.push(masa);
      ph.push(d.getValue(i,1));
      tu.push(d.getValue(i,2));
      te.push(d.getValue(i,3));

      table.innerHTML += `
        <tr>
          <td>${masa}</td>
          <td>${d.getValue(i,1)}</td>
          <td>${d.getValue(i,2)}</td>
          <td>${d.getValue(i,3)}</td>
        </tr>`;
    }

    const lastIndex = r - 1;
    document.getElementById("ph").innerText = d.getValue(lastIndex,1);
    document.getElementById("turbidity").innerText = d.getValue(lastIndex,2);
    document.getElementById("temp").innerText = d.getValue(lastIndex,3);
    document.getElementById("phTime").innerText = d.getValue(lastIndex,0);
    document.getElementById("turTime").innerText = d.getValue(lastIndex,0);
    document.getElementById("tempTime").innerText = d.getValue(lastIndex,0);

    if (window.chart) window.chart.destroy();
    window.chart = new Chart(document.getElementById("chart"), {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          { label: "pH", data: ph, borderWidth: 2, borderColor: "yellow", fill: false },
          { label: "Turbidity", data: tu, borderWidth: 2, borderColor: "cyan", fill: false },
          { label: "Suhu", data: te, borderWidth: 2, borderColor: "lime", fill: false }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "white" } } },
        scales: {
          x: { ticks: { color: "white" } },
          y: { ticks: { color: "white" } }
        }
      }
    });
  });
}
</script>

</body>
</html>
