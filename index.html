<script>
google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(() => {
  loadData();
  // Auto-refresh setiap 10 saat
  setInterval(loadData, 10000);
});

const SHEET_ID = "1dvpDldtPfPRVXpvipldZZs-PlpF2J4ZF-xa1-gFyqKU";
const SHEET_NAME = "Sheet1";

function loadData() {
  const q = new google.visualization.Query(
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}`
  );

  q.send(res => {
    if (res.isError()) {
      console.error(res.getMessage());
      return;
    }

    const d = res.getDataTable();
    const r = d.getNumberOfRows();
    if (r === 0) {
      resetTopBoxes();
      document.getElementById("tableData").innerHTML = "";
      if (window.chart) window.chart.destroy();
      return;
    }

    let labels = [], ph = [], tu = [], te = [];
    let table = document.getElementById("tableData");
    table.innerHTML = "";

    const selectedDate = document.getElementById("dateFilter").value;

    for (let i = 0; i < r; i++) {
      let masa = d.getValue(i,0).toString();
      if (selectedDate && !masa.includes(selectedDate)) continue;

      labels.push(masa);
      ph.push(d.getValue(i,1));
      tu.push(d.getValue(i,2));
      te.push(d.getValue(i,3));

      table.innerHTML += `
        <tr>
          <td>${masa}</td>
          <td>${d.getValue(i,1)}</td>
          <td>${d.getValue(i,2)}</td>
          <td>${d.getValue(i,3)}</td>
        </tr>`;
    }

    if (labels.length > 0) {
      const lastIndex = labels.length - 1;
      document.getElementById("ph").innerText = ph[lastIndex];
      document.getElementById("turbidity").innerText = tu[lastIndex];
      document.getElementById("temp").innerText = te[lastIndex];
      document.getElementById("phTime").innerText = labels[lastIndex];
      document.getElementById("turTime").innerText = labels[lastIndex];
      document.getElementById("tempTime").innerText = labels[lastIndex];
    } else {
      resetTopBoxes();
    }

    if (window.chart) window.chart.destroy();
    window.chart = new Chart(document.getElementById("chart"), {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          { label: "pH", data: ph, borderWidth: 2, borderColor: "yellow", fill: false },
          { label: "Turbidity", data: tu, borderWidth: 2, borderColor: "cyan", fill: false },
          { label: "Suhu", data: te, borderWidth: 2, borderColor: "lime", fill: false }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "white" } } },
        scales: {
          x: { ticks: { color: "white" } },
          y: { ticks: { color: "white" } }
        }
      }
    });
  });
}

function resetTopBoxes() {
  document.getElementById("ph").innerText = "-";
  document.getElementById("turbidity").innerText = "-";
  document.getElementById("temp").innerText = "-";
  document.getElementById("phTime").innerText = "-";
  document.getElementById("turTime").innerText = "-";
  document.getElementById("tempTime").innerText = "-";
}
</script>
